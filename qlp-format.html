<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>QLP – Teste Local</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body{font-family:system-ui,Arial,sans-serif;padding:24px}
    .box{max-width:700px;margin:auto;border:1px solid #ddd;border-radius:12px;padding:20px}
    label{display:block;margin:12px 0 6px}
    button{padding:10px 16px;border-radius:8px;border:0;background:#004aad;color:#fff;font-weight:600}
  </style>
</head>
<body>
  <div class="box">
    <h1>Teste Local – QLP</h1>
    <p>Importe sua planilha QLP. O script vai:</p>
    <ol>
      <li>pular as 4 primeiras linhas;</li>
      <li>manter 46 linhas e pular 5, repetindo;</li>
      <li>parar em uma linha que contenha “total” na primeira coluna;</li>
      <li>renomear/formatar colunas e converter datas (Admissão col 7, Nascimento col 10) para <b>dd/mm/aaaa</b> sem timezone.</li>
    </ol>

    <label for="file">Planilha (.xlsx/.xls/.csv)</label>
    <input id="file" type="file" accept=".xlsx,.xls,.csv"/>

    <div style="margin-top:16px">
      <button id="go" disabled>Baixar planilha formatada</button>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const file = document.getElementById('file');
  const go   = document.getElementById('go');
  let rawData = null;

  // datas sem timezone
  const pad2 = n => String(n).padStart(2,'0');
  function toDDMMYYYY(v){
    if (v == null || v === "") return "";
    if ((typeof v === "number" && isFinite(v)) || (/^\d+(\.\d+)?$/.test(String(v)))){
      const excelEpochUTC = Date.UTC(1899,11,30); // 1899-12-30
      const msUTC = excelEpochUTC + Math.round(Number(v)*86400)*1000;
      const d = new Date(msUTC);
      return `${pad2(d.getUTCDate())}/${pad2(d.getUTCMonth()+1)}/${d.getUTCFullYear()}`;
    }
    const s = String(v).trim();
    let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
    if (m){ let [_, d, mo, y]=m; if (y.length===2) y=(parseInt(y,10)>50?"19":"20")+y; return `${pad2(d)}/${pad2(mo)}/${y}`; }
    m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (m) return `${m[3]}/${m[2]}/${m[1]}`;
    return s;
  }

  const headerMapping = [
    { newName: "CADASTRO",   originalIndex: 0 },
    { newName: "NOME",       originalIndex: 1 },
    { newName: "SITUACAO",   originalIndex: 4 },
    { newName: "FILIAL",     originalIndex: 5 },
    { newName: "VINCULO",    originalIndex: 6 },
    { newName: "ADMISSAO",   originalIndex: 7 },
    { newName: "CARGO",      originalIndex: 8 },
    { newName: "NASCIMENTO", originalIndex:10 },
    { newName: "CTPS",       originalIndex:11 },
    { newName: "SERIE",      originalIndex:13 },
    { newName: "RG",         originalIndex:14 },
    { newName: "CPF",        originalIndex:15 },
    { newName: "PIS",        originalIndex:16 }
  ];
  const keepIdx = headerMapping.map(m => m.originalIndex);
  const newHeaders = headerMapping.map(m => m.newName);

  file.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const data = new Uint8Array(ev.target.result);
      const wb = XLSX.read(data, { type: 'array', raw: true, cellDates: false });
      const ws = wb.Sheets[wb.SheetNames[0]];
      rawData = XLSX.utils.sheet_to_json(ws, { header:1, raw:true, defval:"" });
      go.disabled = false;
    };
    reader.readAsArrayBuffer(f);
  });

  go.addEventListener('click', () => {
    if (!rawData || rawData.length <= 4){ alert('Arquivo inválido.'); return; }
    let rows = rawData.slice(4);

    // 46 mantém / 5 pula
    let outRows = [], kept=0, skipped=0;
    for (let i=0;i<rows.length;i++){
      if (kept < 46){ outRows.push(rows[i]); kept++; }
      else if (skipped < 5){ skipped++; }
      if (skipped === 5){ kept = 0; skipped = 0; }
    }

    // corta no "total"
    const cut = outRows.findIndex(r => r[0] && String(r[0]).toLowerCase().includes('total'));
    if (cut !== -1) outRows = outRows.slice(0, cut);

    // índices úteis
    const idx = name => headerMapping.find(m => m.newName===name).originalIndex;
    const iVinc=idx('VINCULO'), iSit=idx('SITUACAO'), iFil=idx('FILIAL'),
          iCPF=idx('CPF'), iPIS=idx('PIS'), iAdm=idx('ADMISSAO'), iNas=idx('NASCIMENTO');

    const vincMap = {"10":"EFETIVO/CLT","50":"TEMPORARIO","55":"JOVEM APRENDIZ"};
    const sitMap  = {"1":"Trabalhando","2":"Férias","3":"Auxílio Doença","4":"Acidente de Trabalho","5":"Serviço Militar","6":"Licença Maternidade","7":"Demitido"};

    // (mapa de filiais encurtado no demo)
    const filMap = {1:"TALENTOS - CLT",2:"TALENTOS - TEMPORARIO",5:"AMBEV NOVA RIO - CLT",6:"AMBEV NOVA RIO - TEMPORARIO"};

    const formatted = outRows.map(r => {
      const row = [];
      keepIdx.forEach(c => {
        let v = r[c] ?? '';
        if (c === iVinc) v = vincMap[String(v)] || v;
        if (c === iSit)  v = sitMap[String(parseInt(v,10))] || v;
        if (c === iFil)  v = filMap[v] || v;
        if (c === iCPF){ let cpf=String(v).replace(/\D/g,'').padStart(11,'0'); if (cpf.length===11) v=cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4'); }
        if (c === iPIS){ let pis=String(v).replace(/\D/g,'').padStart(11,'0'); if (pis.length===11) v=pis.replace(/(\d{3})(\d{5})(\d{2})(\d{1})/,'$1.$2.$3-$4'); }
        if (c === iAdm || c === iNas) v = toDDMMYYYY(v);
        row.push(v);
      });
      return row;
    });

    formatted.unshift(newHeaders);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(formatted), 'Planilha Formatada');
    XLSX.writeFile(wb, 'QLP-Formatada.xlsx');
  });
});
</script>
</body>
</html>
